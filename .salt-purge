#!/bin/bash -e
# vim: set ts=4 sw=4 sts=4 et :

path="$(readlink -m $0)"
dir="${path%/*}"

source "${dir}/.salt-functions"
source "${dir}/.salt-force-umount"

# -----------------------------------------------------------------------------
# Purge all salt related files
# -----------------------------------------------------------------------------
saltPurge() {
    systemctl stop salt-api salt-minion salt-syndic salt-master
    systemctl disable salt-api salt-minion salt-syndic salt-master

    # Make sure everything is really umounted!
    umount_kill "/srv/salt" || true
    umount_kill "/srv/pillar" || true
    umount_kill "/etc/salt" || true
    umount_kill "/var/cache/salt" || true

    # rw mount salt related files
    rm -rf /rw/usrlocal/etc/salt || true
    rm -rf /rw/usrlocal/srv/salt || true
    rm -rf /rw/usrlocal/srv/salt-formulas || true
    rm -rf /rw/usrlocal/srv/pillar || true
    rm -rf /rw/usrlocal/var/cache/salt || true

    # root filesystem salt related files
    rm -rf /etc/salt || true
    rm -rf /srv/salt || true
    rm -rf /srv/salt-formulas || true
    rm -rf /srv/pillar || true
    rm -rf /var/cache/salt || true
    rm -rf /usr/lib/salt || true

    # Systemd unit files
    rm -rf /lib/systemd/system/salt-*
    rm -rf /etc/systemd/system/salt-*

    # Temp files
    rm -rf /root/src/salt
    rm -rf /tmp/salt-bootstrap

    # Files created by salt
    rm -rf /etc/pki/minion
    rm -f /etc/pki/tls/certs/localhost.*
    rm -f /tmp/.salt*
}

# Run saltPurge if called directly
if [ "${path##*/}" == ".salt-purge" ]; then
    saltPurge
fi
